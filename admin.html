<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mublog Admin - Inventory Control</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f9fafb;
            --sidebar: #111827;
            --text-main: #111827;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius: 12px;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar);
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: white;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        .sidebar-header { padding: 30px 25px; font-size: 22px; font-weight: 700; border-bottom: 1px solid #1f2937; }
        .sidebar-header span { color: var(--primary); }

        .sidebar-nav { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .nav-label { font-size: 11px; text-transform: uppercase; color: #4b5563; margin: 20px 0 10px 10px; font-weight: 700; display: block; }

        .nav-link {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: #9ca3af;
            text-decoration: none; border-radius: var(--radius); font-size: 14px; font-weight: 500;
            cursor: pointer; transition: 0.2s; margin-bottom: 2px;
        }
        .nav-link:hover, .nav-link.active { background: #1f2937; color: white; }

        .sidebar-footer { padding: 20px; border-top: 1px solid #1f2937; background: #0b0f1a; }
        .btn-logout { color: #ef4444; display: flex; align-items: center; gap: 10px; text-decoration: none; font-size: 14px; font-weight: 600; cursor: pointer; padding: 10px; border-radius: 8px; }

        /* --- CONTENT AREA --- */
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; width: 100%; }
        
        header { 
            background: white; 
            padding: 15px 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #e5e7eb; 
        }

        /* --- DASHBOARD STATS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid #e5e7eb; display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .stat-info h3 { margin: 0; font-size: 20px; color: var(--text-main); }
        .stat-info p { margin: 0; font-size: 12px; color: #6b7280; font-weight: 600; }

        /* --- MOBILE NAV --- */
        .mobile-header { display: none; background: var(--sidebar); color: white; padding: 15px 20px; align-items: center; justify-content: space-between; }
        .menu-btn { font-size: 24px; cursor: pointer; color: white; background: none; border: none; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; }

        .scroll-content { padding: 40px; overflow-y: auto; flex-grow: 1; }
        
        .admin-section { display: none; }
        .admin-section.active { display: block; }
        
        /* --- ADMIN CARDS --- */
        .admin-card { background: white; padding: 30px; border-radius: var(--radius); border: 1px solid #e5e7eb; margin-bottom: 30px; }
        h2 { margin-top: 0; font-size: 20px; font-weight: 700; color: var(--text-main); margin-bottom: 25px; }

        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }

        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #4b5563; }
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; 
            font-size: 14px; background: #fff; outline: none; transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        textarea { height: 120px; font-family: monospace; }

        .btn-add { 
            background: var(--primary); color: white; width: 100%; font-size: 15px; 
            margin-top: 15px; border: none; padding: 14px; border-radius: 8px; font-weight: 700; cursor: pointer;
        }
        .btn-add:hover { background: #4338ca; }

        .stock-badge { background: #eef2ff; color: var(--primary); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; display: inline-block; margin-top: 5px; }
        .status-pill { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }

        /* --- TABLE STYLING --- */
        .table-container { width: 100%; overflow-x: auto; } 
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 12px; font-size: 12px; color: #6b7280; text-transform: uppercase; border-bottom: 2px solid #f3f4f6; }
        td { padding: 16px 12px; border-bottom: 1px solid #f3f4f6; font-size: 14px; }
        .balance-amt { color: var(--success); font-weight: 700; }
        .btn-action { background: #eef2ff; color: var(--primary); border: none; padding: 6px 12px; border-radius: 6px; font-weight: 700; font-size: 12px; cursor: pointer; }
        
        .btn-delete { color: #ef4444; background: none; border: none; cursor: pointer; font-size: 16px; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .sidebar-overlay.show { display: block; }
            header { padding: 15px 20px; }
            .scroll-content { padding: 20px; }
            .grid-form { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .admin-card { padding: 20px; }
        }
    </style>
</head>
<body>

    <div class="sidebar-overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">Mublog <span>Admin</span></div>
        <div class="sidebar-nav">
            <div class="nav-label">Main</div>
            <a class="nav-link active" onclick="showSection('dashboardSection', this)"><i class="fas fa-chart-line"></i> Dashboard</a>
            
            <div class="nav-label">Management</div>
            <a class="nav-link" onclick="showSection('inventorySection', this)"><i class="fas fa-box"></i> Inventory Control</a>
            <a class="nav-link" onclick="showSection('userSection', this)"><i class="fas fa-users"></i> Users List</a>
            <a class="nav-link" onclick="showSection('salesSection', this)"><i class="fas fa-receipt"></i> All Sales</a>
            
            <div class="nav-label">Products</div>
            <a class="nav-link" onclick="showSection('manageProductsSection', this)"><i class="fas fa-list"></i> Manage Products</a>
            
            <div class="nav-label">API Settings</div>
            <a class="nav-link" onclick="showSection('smsPriceSection', this)"><i class="fas fa-signal"></i> SMS Prices</a>
            <a class="nav-link" onclick="showSection('announcementSection', this)"><i class="fas fa-bullhorn"></i> Announcements</a>
        </div>
        <div class="sidebar-footer">
            <div class="btn-logout" onclick="logout()"><i class="fas fa-power-off"></i> Logout Admin</div>
        </div>
    </div>

    <div class="main-content">
        <div class="mobile-header">
            <div style="font-weight: 700; font-size: 18px;">Mublog <span>Admin</span></div>
            <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        </div>

        <header>
            <h2 id="pageTitle" style="margin:0; font-size: 18px;">Dashboard Overview</h2>
            <div style="font-weight: 600; color: var(--primary);">System Administrator</div>
        </header>

        <div class="scroll-content">
            <section id="dashboardSection" class="admin-section active">
                <h2 style="font-size: 32px; margin-bottom: 30px; font-weight: 800;">
                    Admin Dashboard üë®‚Äçüíº
                </h2>

                <!-- Modern Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 40px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Sales</div>
                        <div style="font-size: 28px; font-weight: 800;" id="statTotalSales">‚Ç¶0</div>
                        <div style="margin-top: 10px; opacity: 0.8; font-size: 13px;">
                            <i class="fas fa-chart-line"></i> Revenue generated
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 25px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Active Users</div>
                        <div style="font-size: 28px; font-weight: 800;" id="statTotalUsers">0</div>
                        <div style="margin-top: 10px; opacity: 0.8; font-size: 13px;">
                            <i class="fas fa-users"></i> Registered members
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 25px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Total Products</div>
                        <div style="font-size: 28px; font-weight: 800;" id="statTotalStock">0</div>
                        <div style="margin-top: 10px; opacity: 0.8; font-size: 13px;">
                            <i class="fas fa-box"></i> Items in stock
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div style="background: white; padding: 30px; border-radius: 12px; border: 1px solid #e5e7eb; margin-bottom: 30px;">
                    <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 700;">Quick Actions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button onclick="showSection('inventorySection', this)" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 20px; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; text-align: left; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-plus-circle" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            Add Product
                        </button>
                        <button onclick="showSection('userSection', this)" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: none; padding: 20px; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; text-align: left; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-users-cog" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            Manage Users
                        </button>
                        <button onclick="showSection('announcementSection', this)" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border: none; padding: 20px; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; text-align: left; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-bullhorn" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            Post Announcement
                        </button>
                        <button onclick="showSection('smsPriceSection', this)" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: none; padding: 20px; border-radius: 10px; color: white; font-weight: 700; cursor: pointer; text-align: left; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-signal" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            SMS Settings
                        </button>
                    </div>
                </div>
                
                <!-- Recent Sales -->
                <div class="admin-card">
                    <h2><i class="fas fa-chart-bar" style="color: #4f46e5;"></i> Recent Sales Activity</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Item</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="recentSalesBody">
                                <tr><td colspan="4" style="text-align: center; color: #9ca3af; padding: 40px;">Loading sales data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="inventorySection" class="admin-section">
                <div class="admin-card">
                    <h2><i class="fas fa-plus-circle" style="color: #4f46e5;"></i> Add New Product</h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">Upload accounts, subscriptions, or working pictures to your marketplace</p>
                    <form id="productForm">
                        <div class="grid-form">
                            <div>
                                <label>Category</label>
                                <select id="prodCategory">
                                    <option value="Facebook">Facebook</option>
                                    <option value="Instagram">Instagram</option>
                                    <option value="TikTok">TikTok</option>
                                    <option value="Twitter">Twitter</option>
                                    <option value="Netflix">Netflix</option>
                                    <option value="VPN">VPN</option>
                                    <option value="Pictures">Working Pictures</option>
                                </select>
                            </div>
                            <div>
                                <label>Display Name</label>
                                <input type="text" id="prodName" required placeholder="e.g. 2015 Aged FB Account">
                            </div>
                            <div>
                                <label>Price (‚Ç¶)</label>
                                <input type="number" id="prodPrice" required placeholder="0.00">
                            </div>
                            <div>
                                <label>Public Link / Image URL</label>
                                <input type="text" id="prodPublicLink" placeholder="https://... (Profile link or image URL)">
                                <small style="color: #9ca3af; font-size: 11px; display: block; margin-top: 5px;">
                                    For accounts: Profile link | For Pictures: Image preview URL (imgur, imgbb, etc.)
                                </small>
                            </div>
                            <div class="full-width">
                                <label>Public Description</label>
                                <textarea id="prodDetails" style="height: 60px;" placeholder="Brief description visible to buyers..."></textarea>
                            </div>
                            <div class="full-width">
                                <label>Private Credentials (Revealed AFTER purchase)</label>
                                <textarea id="prodCredentials" style="height: 80px;" placeholder="Email:password | Recovery email | Download link" required></textarea>
                                <small style="color: #9ca3af; font-size: 11px; display: block; margin-top: 5px;">
                                    For Pictures: Include full download link (Google Drive, Dropbox, etc.)
                                </small>
                            </div>
                        </div>
                        <button type="submit" class="btn-add">
                            <i class="fas fa-upload"></i> Upload to Marketplace
                        </button>
                    </form>
                </div>
            </section>

            <section id="smsPriceSection" class="admin-section">
                <div class="admin-card">
                    <h2>Manage Allowed SMS Services</h2>
                    <form id="addSmsServiceForm">
                        <div class="grid-form">
                            <div>
                                <label>5sim API Name (e.g., 'whatsapp')</label>
                                <input type="text" id="apiServiceName" required placeholder="whatsapp">
                            </div>
                            <div>
                                <label>Display Name (e.g., 'WhatsApp')</label>
                                <input type="text" id="displayServiceName" required placeholder="WhatsApp">
                            </div>
                        </div>
                        <button type="submit" class="btn-add">Add to Dashboard</button>
                    </form>
                    
                    <div class="table-container" style="margin-top: 30px;">
                        <h3>Active Services</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Display Name</th>
                                    <th>API ID</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="smsPriceBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="userSection" class="admin-section">
                <div class="admin-card">
                    <h2>User Management</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Balance</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="salesSection" class="admin-section">
                <div class="admin-card">
                    <h2>All Sales History</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Item</th>
                                    <th>Price</th>
                                    <th>Content</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="manageProductsSection" class="admin-section">
                <div class="admin-card">
                    <h2>Current Inventory</h2>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock Left</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="manageTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- ANNOUNCEMENT SECTION -->
            <section id="announcementSection" class="admin-section">
                <div class="admin-card">
                    <h2><i class="fas fa-bullhorn"></i> Post Announcement</h2>
                    <p style="color: #6b7280; margin-bottom: 20px;">Post updates, warnings, or important information for your users</p>
                    
                    <form id="announcementForm">
                        <div class="grid-form">
                            <div>
                                <label>Announcement Type</label>
                                <select id="announceType" required>
                                    <option value="info">Information</option>
                                    <option value="warning">Warning/Alert</option>
                                    <option value="success">Success/Good News</option>
                                </select>
                            </div>
                            <div>
                                <label>Title</label>
                                <input type="text" id="announceTitle" placeholder="e.g., System Maintenance" required>
                            </div>
                            <div class="full-width">
                                <label>Message</label>
                                <textarea id="announceMessage" placeholder="Your announcement message here..." required style="height: 100px; font-family: 'Plus Jakarta Sans', sans-serif;"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn-add">üì¢ Publish Announcement</button>
                    </form>
                </div>

                <div class="admin-card">
                    <h2>Current Announcement</h2>
                    <div id="currentAnnouncement" style="background: #f9fafb; padding: 20px; border-radius: 8px; border: 1px dashed #e5e7eb; text-align: center; color: #9ca3af;">
                        No active announcement
                    </div>
                    <button onclick="removeAnnouncement()" class="btn-add" style="background: #ef4444; margin-top: 15px;">
                        <i class="fas fa-trash"></i> Remove Announcement
                    </button>
                </div>
            </section>
        </div>
    </div>

<script>
    const API_BASE = "http://localhost:5000/api";

    const getHeaders = () => ({
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
    });

    if (localStorage.getItem('userRole') !== 'admin') {
        window.location.href = 'login.html';
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('show');
    }

    // --- MAIN NAVIGATION ---
    function showSection(sectionId, element) {
        if(window.innerWidth <= 768) toggleSidebar();
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        if(element) element.classList.add('active');

        const titles = {
            'dashboardSection': 'Dashboard Overview',
            'inventorySection': 'Inventory Control',
            'userSection': 'User Management',
            'salesSection': 'Sales History',
            'manageProductsSection': 'Manage Inventory',
            'smsPriceSection': 'SMS Pricing'
        };
        document.getElementById('pageTitle').innerText = titles[sectionId];

        if(sectionId === 'dashboardSection') loadDashboardStats();
        if(sectionId === 'userSection') loadUsers();
        if(sectionId === 'salesSection') loadAllSales();
        if(sectionId === 'manageProductsSection') loadInventory();
        if(sectionId === 'smsPriceSection') loadSmsPrices();
    }

    // --- DASHBOARD ---
    // REPLACE THE loadDashboardStats FUNCTION IN admin.html (around line 330)

async function loadDashboardStats() {
    try {
        // Fetch users
        const usersRes = await fetch(`${API_BASE}/auth/users`, { headers: getHeaders() });
        const users = await usersRes.json();
        console.log('Users:', users);

        // Fetch all orders from orders table
        const ordersRes = await fetch(`${API_BASE}/products/all-orders`, { headers: getHeaders() });
        const orders = await ordersRes.json();
        console.log('Orders:', orders);

        // Fetch products
        const prodRes = await fetch(`${API_BASE}/products/all`, { headers: getHeaders() });
        const products = await prodRes.json();
        console.log('Products:', products);

        // Calculate total sales (sum of price column)
        const totalSales = orders.reduce((sum, o) => sum + parseFloat(o.price || 0), 0);
        
        // Calculate total stock
        const totalStock = products.reduce((sum, p) => sum + (parseInt(p.stock) || 0), 0);

        // Update UI
        document.getElementById('statTotalSales').innerText = `‚Ç¶${totalSales.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        document.getElementById('statTotalUsers').innerText = users.length || 0;
        document.getElementById('statTotalStock').innerText = totalStock || 0;

        // Show recent sales in table
        const recentSalesBody = document.getElementById('recentSalesBody');
        if (!orders || orders.length === 0) {
            recentSalesBody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#6b7280;">No sales recorded.</td></tr>';
        } else {
            recentSalesBody.innerHTML = orders.slice(0, 5).map(o => `
                <tr>
                    <td>${new Date(o.created_at).toLocaleDateString()}</td>
                    <td>${o.username || 'Unknown'}</td>
                    <td>${o.product_name || 'Unknown'}</td>
                    <td class="balance-amt">‚Ç¶${parseFloat(o.price || 0).toLocaleString()}</td>
                </tr>
            `).join('');
        }
    } catch (e) { 
        console.error("Dashboard stats error:", e);
        document.getElementById('statTotalSales').innerText = '‚Ç¶0';
        document.getElementById('statTotalUsers').innerText = '0';
        document.getElementById('statTotalStock').innerText = '0';
    }
}

// REPLACE THE loadAllSales FUNCTION IN admin.html (around line 488)

async function loadAllSales() {
    try {
        const res = await fetch(`${API_BASE}/products/all-orders`, { headers: getHeaders() });
        const sales = await res.json();
        console.log('All sales:', sales);
        
        const body = document.getElementById('salesTableBody');
        
        if (!sales || sales.length === 0) {
            body.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#6b7280;">No sales recorded.</td></tr>';
            return;
        }
        
        body.innerHTML = sales.map(s => `
            <tr>
                <td>${new Date(s.created_at).toLocaleDateString()}</td>
                <td><strong>${s.username || 'User'}</strong></td>
                <td>${s.product_name || 'Unknown'}</td>
                <td class="balance-amt">‚Ç¶${parseFloat(s.price || 0).toLocaleString()}</td>
                <td><code>${s.product_link ? s.product_link.substring(0, 30) : 'N/A'}...</code></td>
            </tr>
        `).join('');
    } catch (e) { 
        console.error("Load all sales error:", e);
        document.getElementById('salesTableBody').innerHTML = '<tr><td colspan="5">Error loading sales</td></tr>';
    }
}

    // --- SMS MANAGEMENT ---
    async function loadSmsPrices() {
        try {
            const res = await fetch(`${API_BASE}/sms/admin-all-prices`, { headers: getHeaders() });
            const services = await res.json();
            const body = document.getElementById('smsPriceBody');
            if(!body) return;

            if (services.length === 0) {
                body.innerHTML = '<tr><td colspan="3">No services added yet.</td></tr>';
                return;
            }

            body.innerHTML = services.map(s => `
                <tr>
                    <td>${s.display_name}</td>
                    <td><code>${s.service_name}</code></td>
                    <td>
                        <button onclick="deleteSmsService(${s.id})" class="btn-delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (e) { console.error("Load SMS Error:", e); }
    }

    async function deleteSmsService(id) {
        if(!confirm("Remove this service?")) return;
        try {
            const res = await fetch(`${API_BASE}/sms/delete-allowed/${id}`, { 
                method: 'DELETE', 
                headers: getHeaders() 
            });
            if(res.ok) loadSmsPrices();
        } catch (err) { alert("Failed to delete"); }
    }

    // --- PRODUCT UPLOAD ---
    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            category: document.getElementById('prodCategory').value,
            name: document.getElementById('prodName').value,
            price: parseFloat(document.getElementById('prodPrice').value),
            public_link: document.getElementById('prodPublicLink').value,
            description: document.getElementById('prodDetails').value,
            credentials: document.getElementById('prodCredentials').value,
            stock: 1 
        };

        try {
            const res = await fetch(`${API_BASE}/products/add`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(data)
            });
            if(res.ok) {
                alert("‚úÖ Product Published!");
                document.getElementById('productForm').reset();
                loadDashboardStats();
            }
        } catch (err) { alert("Server connection error"); }
    });

    // --- SMS FORM SUBMISSION ---
    document.getElementById('addSmsServiceForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            service_name: document.getElementById('apiServiceName').value.toLowerCase().trim(),
            display_name: document.getElementById('displayServiceName').value.trim()
        };

        try {
            const res = await fetch(`${API_BASE}/sms/add-allowed`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(data)
            });
            if(res.ok) {
                alert("‚úÖ Service Added!");
                document.getElementById('addSmsServiceForm').reset();
                loadSmsPrices();
            } else {
                const err = await res.json();
                alert("‚ùå " + err.error);
            }
        } catch (err) { alert("Error connecting to server"); }
    });

    // --- USER MANAGEMENT ---
    async function loadUsers() {
        try {
            const res = await fetch(`${API_BASE}/auth/users`, { headers: getHeaders() });
            const users = await res.json();
            const body = document.getElementById('userTableBody');
            body.innerHTML = users.map(u => `
                <tr>
                    <td>#${u.id}</td>
                    <td><strong>${u.username}</strong></td>
                    <td>${u.email}</td>
                    <td><span class="balance-amt">‚Ç¶${parseFloat(u.balance).toLocaleString()}</span></td>
                    <td><button class="btn-action" onclick="topUp(${u.id}, '${u.username}')">Add Cash</button></td>
                </tr>
            `).join('');
        } catch (e) { }
    }

    async function topUp(id, name) {
        const amt = prompt(`Enter Naira amount to add to ${name}:`);
        if(!amt || isNaN(amt)) return;
        try {
            const res = await fetch(`${API_BASE}/auth/topup`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify({ userId: id, amount: parseFloat(amt) })
            });
            if(res.ok) {
                alert("Wallet updated!");
                loadUsers();
            }
        } catch (err) { alert("Server error"); }
    }

    // --- INVENTORY MANAGEMENT ---
    async function loadInventory() {
        try {
            const res = await fetch(`${API_BASE}/products/all`, { headers: getHeaders() });
            const products = await res.json();
            const body = document.getElementById('manageTableBody');
            body.innerHTML = products.map(p => `
                <tr>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.category}</td>
                    <td>‚Ç¶${parseFloat(p.price).toLocaleString()}</td>
                    <td><span class="stock-badge">Stock: ${p.stock || 0}</span></td>
                    <td>
                        <button onclick="deleteProduct(${p.id})" class="btn-delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (e) { }
    }

    async function deleteProduct(id) {
        if(!confirm("Delete this product?")) return;
        try {
            const res = await fetch(`${API_BASE}/products/delete/${id}`, { 
                method: 'DELETE',
                headers: getHeaders()
            });
            if(res.ok) loadInventory();
        } catch (err) { alert("Delete failed"); }
    }

    async function loadAllSales() {
        try {
            const res = await fetch(`${API_BASE}/products/all-orders`, { headers: getHeaders() });
            const sales = await res.json();
            const body = document.getElementById('salesTableBody');
            body.innerHTML = sales.map(s => `
                <tr>
                    <td>${new Date(s.created_at).toLocaleDateString()}</td>
                    <td><strong>${s.username || 'User'}</strong></td>
                    <td>${s.product_name}</td>
                    <td class="balance-amt">‚Ç¶${parseFloat(s.price).toLocaleString()}</td>
                    <td><code>${s.product_link ? s.product_link.substring(0, 30) : 'N/A'}...</code></td>
                </tr>
            `).join('');
        } catch (e) { }
    }

    function logout() { 
        localStorage.clear(); 
        window.location.href = 'login.html'; 
    }

    // --- ANNOUNCEMENT MANAGEMENT ---
    async function loadCurrentAnnouncement() {
        try {
            const res = await fetch(`${API_BASE}/announcement`);
            const announcement = await res.json();
            const display = document.getElementById('currentAnnouncement');
            
            if (announcement && announcement.title) {
                const typeColors = {
                    'info': '#4f46e5',
                    'warning': '#f59e0b',
                    'success': '#10b981'
                };
                display.innerHTML = `
                    <div style="text-align: left;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="background: ${typeColors[announcement.type]}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase;">
                                ${announcement.type}
                            </span>
                            <span style="color: #9ca3af; font-size: 12px;">
                                ${new Date(announcement.created_at).toLocaleString()}
                            </span>
                        </div>
                        <h3 style="margin: 0 0 8px 0; color: #111827;">${announcement.title}</h3>
                        <p style="margin: 0; color: #6b7280; line-height: 1.6;">${announcement.message}</p>
                    </div>
                `;
            } else {
                display.innerHTML = '<p style="margin:0; color: #9ca3af;">No active announcement</p>';
            }
        } catch (e) {
            console.error('Load announcement error:', e);
        }
    }

    document.getElementById('announcementForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            type: document.getElementById('announceType').value,
            title: document.getElementById('announceTitle').value,
            message: document.getElementById('announceMessage').value
        };

        try {
            const res = await fetch(`${API_BASE}/admin/announcement`, {
                method: 'POST',
                headers: getHeaders(),
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                alert('‚úÖ Announcement published!');
                document.getElementById('announcementForm').reset();
                loadCurrentAnnouncement();
            } else {
                alert('Failed to publish announcement');
            }
        } catch (err) {
            alert('Server error');
        }
    });

    async function removeAnnouncement() {
        if (!confirm('Remove the current announcement?')) return;
        
        try {
            const res = await fetch(`${API_BASE}/admin/announcement`, {
                method: 'DELETE',
                headers: getHeaders()
            });
            
            if (res.ok) {
                alert('Announcement removed');
                loadCurrentAnnouncement();
            }
        } catch (err) {
            alert('Failed to remove');
        }
    }

    window.onload = () => {
        loadDashboardStats();
        loadCurrentAnnouncement();
    };
</script>
</body>
</html>